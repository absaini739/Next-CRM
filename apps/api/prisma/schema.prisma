generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User & Auth
model User {
  id              Int       @id @default(autoincrement())
  name            String
  email           String    @unique
  password        String?
  status          Boolean   @default(false)
  role_id         Int
  remember_token  String?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  role                Role      @relation(fields: [role_id], references: [id])
  persons             Person[]
  organizations       Organization[]
  leads               Lead[]
  deals               Deal[]
  quotes              Quote[]
  activities          Activity[]
  emails              Email[]
  tasksAssignedTo     Task[]    @relation("TasksAssignedTo")
  tasksAssignedBy     Task[]    @relation("TasksAssignedBy")
  taskComments        TaskComment[]
  taskTimeLogs        TaskTimeLog[]
  calendarEvents      CalendarEvent[]

  @@map("users")
}

model Role {
  id              Int       @id @default(autoincrement())
  name            String
  description     String?
  permission_type String
  permissions     Json?     // Stores array of permission strings/objects
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  users           User[]

  @@map("roles")
}

model Group {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("groups")
}

// Contacts
model Person {
  id              Int       @id @default(autoincrement())
  name            String
  emails          Json      // Stores array of {value, label}
  contact_numbers Json?     // Stores array of {value, label}
  organization_id Int?
  user_id         Int?      // Owner
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  organization    Organization? @relation(fields: [organization_id], references: [id])
  user            User?         @relation(fields: [user_id], references: [id])
  leads           Lead[]
  deals           Deal[]
  quotes          Quote[]
  activities      Activity[]
  sentEmails      Email[]
  tasks           Task[]
  calendarEvents  CalendarEvent[]

  @@map("persons")
}

model Organization {
  id          Int      @id @default(autoincrement())
  name        String
  email       String?
  phone       String?
  website     String?
  address     String?
  user_id     Int?     // Owner
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  user        User?    @relation(fields: [user_id], references: [id])
  persons     Person[]
  leads       Lead[]
  deals       Deal[]
  quotes      Quote[]
  activities  Activity[]
  tasks       Task[]
  calendarEvents CalendarEvent[]

  @@map("organizations")
}

// Sales
model Lead {
  id              Int       @id @default(autoincrement())
  title           String
  description     String?
  lead_value      Decimal?  @db.Decimal(10, 2)
  status          Int?      // 0 = lost, 1 = won, null = in progress
  person_id       Int?
  organization_id Int?
  user_id         Int?      // Owner
  pipeline_id     Int?
  stage_id        Int?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  person          Person?       @relation(fields: [person_id], references: [id])
  organization    Organization? @relation(fields: [organization_id], references: [id])
  user            User?         @relation(fields: [user_id], references: [id])
  pipeline        LeadPipeline? @relation(fields: [pipeline_id], references: [id])
  stage           LeadStage?    @relation(fields: [stage_id], references: [id])
  deals           Deal[]
  quotes          Quote[]
  activities      Activity[]
  emails          Email[]
  tasks           Task[]
  calendarEvents  CalendarEvent[]

  @@map("leads")
}

model LeadPipeline {
  id          Int      @id @default(autoincrement())
  name        String
  is_default  Boolean  @default(false)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  stages      LeadStage[]
  leads       Lead[]

  @@map("lead_pipelines")
}

model LeadStage {
  id          Int      @id @default(autoincrement())
  name        String
  pipeline_id Int
  sort_order  Int      @default(0)
  probability Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  pipeline    LeadPipeline @relation(fields: [pipeline_id], references: [id], onDelete: Cascade)
  leads       Lead[]

  @@map("lead_stages")
}

model Deal {
  id                  Int       @id @default(autoincrement())
  title               String
  description         String?
  deal_value          Decimal?  @db.Decimal(10, 2)
  expected_close_date DateTime?
  status              String    @default("open") // open, won, lost
  person_id           Int?
  organization_id     Int?
  lead_id             Int?
  user_id             Int?      // Owner
  pipeline_id         Int?
  stage_id            Int?
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  person              Person?       @relation(fields: [person_id], references: [id])
  organization        Organization? @relation(fields: [organization_id], references: [id])
  lead                Lead?         @relation(fields: [lead_id], references: [id])
  user                User?         @relation(fields: [user_id], references: [id])
  pipeline            DealPipeline? @relation(fields: [pipeline_id], references: [id])
  stage               DealStage?    @relation(fields: [stage_id], references: [id])
  quotes              Quote[]
  activities          Activity[]
  emails              Email[]
  tasks               Task[]
  calendarEvents      CalendarEvent[]

  @@map("deals")
}

model DealPipeline {
  id          Int      @id @default(autoincrement())
  name        String
  is_default  Boolean  @default(false)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  stages      DealStage[]
  deals       Deal[]

  @@map("deal_pipelines")
}

model DealStage {
  id          Int      @id @default(autoincrement())
  name        String
  pipeline_id Int
  sort_order  Int      @default(0)
  probability Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  pipeline    DealPipeline @relation(fields: [pipeline_id], references: [id], onDelete: Cascade)
  deals       Deal[]

  @@map("deal_stages")
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  sku         String?  @unique
  description String?
  price       Decimal? @db.Decimal(10, 2)
  quantity    Int?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  quoteItems  QuoteItem[]

  @@map("products")
}

model Quote {
  id              Int       @id @default(autoincrement())
  quote_number    String    @unique
  subject         String?
  description     String?
  sub_total       Decimal?  @db.Decimal(10, 2)
  discount_amount Decimal?  @db.Decimal(10, 2)
  tax_amount      Decimal?  @db.Decimal(10, 2)
  adjustment      Decimal?  @db.Decimal(10, 2)
  grand_total     Decimal?  @db.Decimal(10, 2)
  valid_until     DateTime?
  person_id       Int?
  organization_id Int?
  lead_id         Int?
  deal_id         Int?
  user_id         Int?      // Owner
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  person          Person?       @relation(fields: [person_id], references: [id])
  organization    Organization? @relation(fields: [organization_id], references: [id])
  lead            Lead?         @relation(fields: [lead_id], references: [id])
  deal            Deal?         @relation(fields: [deal_id], references: [id])
  user            User?         @relation(fields: [user_id], references: [id])
  items           QuoteItem[]

  @@map("quotes")
}

model QuoteItem {
  id          Int      @id @default(autoincrement())
  quote_id    Int
  product_id  Int?
  description String?
  quantity    Int      @default(1)
  price       Decimal  @db.Decimal(10, 2)
  discount    Decimal? @db.Decimal(10, 2)
  tax         Decimal? @db.Decimal(10, 2)
  amount      Decimal  @db.Decimal(10, 2)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  quote       Quote    @relation(fields: [quote_id], references: [id], onDelete: Cascade)
  product     Product? @relation(fields: [product_id], references: [id])

  @@map("quote_items")
}

// Email
model Email {
  id          Int      @id @default(autoincrement())
  from        String
  to          Json     // Array of email addresses
  cc          Json?    // Array of email addresses
  bcc         Json?    // Array of email addresses
  subject     String
  body        String
  folder      String   @default("inbox") // inbox, draft, outbox, sent, archive, trash
  is_read     Boolean  @default(false)
  is_starred  Boolean  @default(false)
  sent_at     DateTime?
  user_id     Int
  person_id   Int?
  lead_id     Int?
  deal_id     Int?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  user        User     @relation(fields: [user_id], references: [id])
  person      Person?  @relation(fields: [person_id], references: [id])
  lead        Lead?    @relation(fields: [lead_id], references: [id])
  deal        Deal?    @relation(fields: [deal_id], references: [id])
  attachments EmailAttachment[]

  @@map("emails")
}

model EmailAttachment {
  id          Int      @id @default(autoincrement())
  email_id    Int
  filename    String
  file_path   String
  file_size   Int?
  mime_type   String?
  created_at  DateTime @default(now())

  email       Email    @relation(fields: [email_id], references: [id], onDelete: Cascade)

  @@map("email_attachments")
}

// Activities & Tasks
model Activity {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  type        String   // call, meeting, task, email, note
  start_at    DateTime?
  end_at      DateTime?
  completed   Boolean  @default(false)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  user_id     Int
  person_id   Int?
  lead_id     Int?
  deal_id     Int?

  user        User     @relation(fields: [user_id], references: [id])
  person      Person?  @relation(fields: [person_id], references: [id])
  lead        Lead?    @relation(fields: [lead_id], references: [id])
  deal        Deal?    @relation(fields: [deal_id], references: [id])

  @@map("activities")
}

// Task Management
model Task {
  id                  Int       @id @default(autoincrement())
  title               String
  description         String?
  task_type           String    // call, meeting, email, follow-up, deadline, custom
  priority            String    @default("medium") // low, medium, high, urgent
  status              String    @default("to_do") // to_do, in_progress, completed, cancelled
  
  due_date            DateTime?
  due_time            String?
  estimated_duration  Int?      // in minutes
  actual_duration     Int?      // in minutes
  
  // Assignment
  assigned_to_id      Int
  assigned_by_id      Int
  
  // CRM Relations
  person_id           Int?
  organization_id     Int?
  lead_id             Int?
  deal_id             Int?
  
  // Recurrence
  is_recurring        Boolean   @default(false)
  recurrence_pattern  String?   // daily, weekly, monthly, custom
  recurrence_end_date DateTime?
  parent_task_id      Int?      // for recurring task instances
  
  // Metadata
  tags                Json?     // array of tags
  attachments         Json?     // array of file URLs
  checklist           Json?     // array of checklist items
  
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt
  completed_at        DateTime?
  
  // Relations
  assigned_to         User      @relation("TasksAssignedTo", fields: [assigned_to_id], references: [id])
  assigned_by         User      @relation("TasksAssignedBy", fields: [assigned_by_id], references: [id])
  person              Person?   @relation(fields: [person_id], references: [id])
  organization        Organization? @relation(fields: [organization_id], references: [id])
  lead                Lead?     @relation(fields: [lead_id], references: [id])
  deal                Deal?     @relation(fields: [deal_id], references: [id])
  parent_task         Task?     @relation("RecurringTasks", fields: [parent_task_id], references: [id])
  child_tasks         Task[]    @relation("RecurringTasks")
  comments            TaskComment[]
  time_logs           TaskTimeLog[]
  calendar_events     CalendarEvent[]
  
  @@map("tasks")
}

model TaskComment {
  id         Int      @id @default(autoincrement())
  task_id    Int
  user_id    Int
  comment    String
  created_at DateTime @default(now())
  
  task       Task     @relation(fields: [task_id], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [user_id], references: [id])
  
  @@map("task_comments")
}

model TaskTimeLog {
  id         Int      @id @default(autoincrement())
  task_id    Int
  user_id    Int
  duration   Int      // in minutes
  note       String?
  logged_at  DateTime @default(now())
  
  task       Task     @relation(fields: [task_id], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [user_id], references: [id])
  
  @@map("task_time_logs")
}

// Calendar
model CalendarEvent {
  id              Int       @id @default(autoincrement())
  title           String
  description     String?
  event_type      String    // meeting, call, deadline, personal
  start_date      DateTime
  end_date        DateTime
  all_day         Boolean   @default(false)
  location        String?
  
  user_id         Int
  task_id         Int?      // linked task if applicable
  
  // CRM Relations
  person_id       Int?
  organization_id Int?
  lead_id         Int?
  deal_id         Int?
  
  // Recurrence
  is_recurring    Boolean   @default(false)
  recurrence_pattern String?
  
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  user            User      @relation(fields: [user_id], references: [id])
  task            Task?     @relation(fields: [task_id], references: [id])
  person          Person?   @relation(fields: [person_id], references: [id])
  organization    Organization? @relation(fields: [organization_id], references: [id])
  lead            Lead?     @relation(fields: [lead_id], references: [id])
  deal            Deal?     @relation(fields: [deal_id], references: [id])
  
  @@map("calendar_events")
}
