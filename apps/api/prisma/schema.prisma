generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  Int             @id @default(autoincrement())
  name                String
  email               String          @unique
  password            String?
  status              Boolean         @default(false)
  role_id             Int
  remember_token      String?
  created_at          DateTime        @default(now())
  updated_at          DateTime        @updatedAt
  deal_updates        Boolean         @default(true)
  email_notifications Boolean         @default(true)
  push_notifications  Boolean         @default(true)
  reports_to_id       Int?
  task_reminders      Boolean         @default(true)
  activities          Activity[]
  calendarEvents      CalendarEvent[]
  callRecordings      CallRecording[]
  deals               Deal[]
  email_accounts      EmailAccount[]  @relation("UserEmailAccounts")
  emailTemplates      EmailTemplate[]
  emails              Email[]
  leadsAssignedTo     Lead[]          @relation("LeadsAssignedTo")
  leads               Lead[]
  notifications       Notification[]
  organizations       Organization[]
  persons             Person[]
  quotes              Quote[]
  taskComments        TaskComment[]
  taskTimeLogs        TaskTimeLog[]
  tasksAssignedBy     Task[]          @relation("TasksAssignedBy")
  tasksAssignedTo     Task[]          @relation("TasksAssignedTo")
  reports_to          User?           @relation("Hierarchy", fields: [reports_to_id], references: [id])
  subordinates        User[]          @relation("Hierarchy")
  role                Role            @relation(fields: [role_id], references: [id])

  @@map("users")
}

model Role {
  id              Int      @id @default(autoincrement())
  name            String
  description     String?
  permission_type String
  permissions     Json?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  users           User[]

  @@map("roles")
}

model Group {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  description String?

  @@map("groups")
}

model Person {
  id              Int             @id @default(autoincrement())
  name            String
  emails          Json
  contact_numbers Json?
  organization_id Int?
  user_id         Int?
  created_at      DateTime        @default(now())
  updated_at      DateTime        @updatedAt
  activities      Activity[]
  calendarEvents  CalendarEvent[]
  deals           Deal[]
  email_messages  EmailMessage[]  @relation("EmailMessagePerson")
  sentEmails      Email[]
  leads           Lead[]
  organization    Organization?   @relation(fields: [organization_id], references: [id])
  user            User?           @relation(fields: [user_id], references: [id])
  quotes          Quote[]
  tasks           Task[]

  @@map("persons")
}

model Organization {
  id             Int             @id @default(autoincrement())
  name           String
  address        Json?
  user_id        Int?
  created_at     DateTime        @default(now())
  updated_at     DateTime        @updatedAt
  email          String?
  phone          String?
  website        String?
  activities     Activity[]
  calendarEvents CalendarEvent[]
  deals          Deal[]
  leads          Lead[]
  user           User?           @relation(fields: [user_id], references: [id])
  persons        Person[]
  quotes         Quote[]
  tasks          Task[]

  @@map("organizations")
}

model Lead {
  id              Int             @id @default(autoincrement())
  title           String
  description     String?
  lead_value      Decimal?        @db.Decimal(10, 2)
  status          Int?
  created_at      DateTime        @default(now())
  updated_at      DateTime        @updatedAt
  user_id         Int?
  person_id       Int?
  lead_source_id  Int?
  lead_type_id    Int?
  organization_id Int?
  pipeline_id     Int?
  stage_id        Int?
  company_name    String?
  first_name      String?
  job_title       String?
  last_name       String?
  lead_rating     String?
  linkedin_url    String?
  location        String?
  mobile          String?
  no_employees    String?
  phone           String?
  primary_email   String?
  secondary_email String?
  website         String?
  product_interest String?
  assigned_to_id  Int?
  lead_score      Int?            @default(0)
  tags            Json?
  activities      Activity[]
  calendarEvents  CalendarEvent[]
  deals           Deal[]
  email_messages  EmailMessage[]  @relation("EmailMessageLead")
  emails          Email[]
  assigned_to     User?           @relation("LeadsAssignedTo", fields: [assigned_to_id], references: [id])
  notifications   Notification[]
  source          LeadSource?     @relation(fields: [lead_source_id], references: [id])
  type            LeadType?       @relation(fields: [lead_type_id], references: [id])
  organization    Organization?   @relation(fields: [organization_id], references: [id])
  person          Person?         @relation(fields: [person_id], references: [id])
  pipeline        LeadPipeline?   @relation(fields: [pipeline_id], references: [id])
  stage           LeadStage?      @relation(fields: [stage_id], references: [id])
  user            User?           @relation(fields: [user_id], references: [id])
  quotes          Quote[]
  tasks           Task[]

  @@map("leads")
}

model LeadPipeline {
  id         Int         @id @default(autoincrement())
  name       String
  created_at DateTime    @default(now())
  is_default Boolean     @default(false)
  updated_at DateTime    @updatedAt
  stages     LeadStage[]
  leads      Lead[]

  @@map("lead_pipelines")
}

model LeadStage {
  id          Int          @id @default(autoincrement())
  name        String
  created_at  DateTime     @default(now())
  pipeline_id Int
  probability Int          @default(0)
  sort_order  Int          @default(0)
  updated_at  DateTime     @updatedAt
  pipeline    LeadPipeline @relation(fields: [pipeline_id], references: [id], onDelete: Cascade)
  leads       Lead[]

  @@map("lead_stages")
}

model Deal {
  id                  Int             @id @default(autoincrement())
  title               String
  description         String?
  deal_value          Decimal?        @db.Decimal(10, 2)
  status              String          @default("open")
  expected_close_date DateTime?
  created_at          DateTime        @default(now())
  updated_at          DateTime        @updatedAt
  user_id             Int?
  person_id           Int?
  lead_id             Int?
  organization_id     Int?
  pipeline_id         Int?
  stage_id            Int?
  activities          Activity[]
  calendarEvents      CalendarEvent[]
  lead                Lead?           @relation(fields: [lead_id], references: [id])
  organization        Organization?   @relation(fields: [organization_id], references: [id])
  person              Person?         @relation(fields: [person_id], references: [id])
  pipeline            DealPipeline?   @relation(fields: [pipeline_id], references: [id])
  stage               DealStage?      @relation(fields: [stage_id], references: [id])
  user                User?           @relation(fields: [user_id], references: [id])
  email_messages      EmailMessage[]  @relation("EmailMessageDeal")
  emails              Email[]
  quotes              Quote[]
  tasks               Task[]

  @@map("deals")
}

model DealPipeline {
  id         Int         @id @default(autoincrement())
  name       String
  is_default Boolean     @default(false)
  created_at DateTime    @default(now())
  updated_at DateTime    @updatedAt
  stages     DealStage[]
  deals      Deal[]

  @@map("deal_pipelines")
}

model DealStage {
  id          Int          @id @default(autoincrement())
  name        String
  pipeline_id Int
  sort_order  Int          @default(0)
  probability Int          @default(0)
  created_at  DateTime     @default(now())
  updated_at  DateTime     @updatedAt
  pipeline    DealPipeline @relation(fields: [pipeline_id], references: [id], onDelete: Cascade)
  deals       Deal[]

  @@map("deal_stages")
}

model Product {
  id          Int         @id @default(autoincrement())
  sku         String?     @unique
  name        String
  description String?
  quantity    Int?
  price       Decimal?    @db.Decimal(10, 2)
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt
  quoteItems  QuoteItem[]

  @@map("products")
}

model Quote {
  id              Int           @id @default(autoincrement())
  subject         String?
  description     String?
  discount_amount Decimal?      @db.Decimal(10, 2)
  tax_amount      Decimal?      @db.Decimal(10, 2)
  sub_total       Decimal?      @db.Decimal(10, 2)
  grand_total     Decimal?      @db.Decimal(10, 2)
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  person_id       Int?
  user_id         Int?
  adjustment      Decimal?      @db.Decimal(10, 2)
  deal_id         Int?
  lead_id         Int?
  organization_id Int?
  quote_number    String        @unique
  valid_until     DateTime?
  items           QuoteItem[]
  deal            Deal?         @relation(fields: [deal_id], references: [id])
  lead            Lead?         @relation(fields: [lead_id], references: [id])
  organization    Organization? @relation(fields: [organization_id], references: [id])
  person          Person?       @relation(fields: [person_id], references: [id])
  user            User?         @relation(fields: [user_id], references: [id])

  @@map("quotes")
}

model QuoteItem {
  id          Int      @id @default(autoincrement())
  quantity    Int      @default(1)
  price       Decimal  @db.Decimal(10, 2)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  product_id  Int?
  quote_id    Int
  amount      Decimal  @db.Decimal(10, 2)
  description String?
  discount    Decimal? @db.Decimal(10, 2)
  tax         Decimal? @db.Decimal(10, 2)
  product     Product? @relation(fields: [product_id], references: [id])
  quote       Quote    @relation(fields: [quote_id], references: [id], onDelete: Cascade)

  @@map("quote_items")
}

model Email {
  id           Int               @id @default(autoincrement())
  from         String
  to           Json
  cc           Json?
  bcc          Json?
  subject      String
  body         String
  folder       String            @default("inbox")
  is_read      Boolean           @default(false)
  is_starred   Boolean           @default(false)
  sent_at      DateTime?
  created_at   DateTime          @default(now())
  updated_at   DateTime          @updatedAt
  user_id      Int
  person_id    Int?
  lead_id      Int?
  deal_id      Int?
  scheduled_at DateTime?
  attachments  EmailAttachment[]
  deal         Deal?             @relation(fields: [deal_id], references: [id])
  lead         Lead?             @relation(fields: [lead_id], references: [id])
  person       Person?           @relation(fields: [person_id], references: [id])
  user         User              @relation(fields: [user_id], references: [id])

  @@map("emails")
}

model EmailAttachment {
  id         Int      @id @default(autoincrement())
  filename   String
  email_id   Int
  created_at DateTime @default(now())
  file_path  String
  file_size  Int?
  mime_type  String?
  email      Email    @relation(fields: [email_id], references: [id], onDelete: Cascade)

  @@map("email_attachments")
}

model EmailAccount {
  id                 Int            @id @default(autoincrement())
  user_id            Int
  provider           String
  email              String
  display_name       String?
  access_token       String
  refresh_token      String?
  token_expiry       DateTime?
  last_sync_at       DateTime?
  sync_enabled       Boolean        @default(true)
  sync_from_date     DateTime?
  is_default         Boolean        @default(false)
  signature          String?
  provider_data      Json?
  created_at         DateTime       @default(now())
  updated_at         DateTime       @updatedAt
  connection_type    String?        @default("oauth")
  encrypted_password String?
  encryption_type    String?
  imap_host          String?
  imap_port          Int?
  imap_username      String?
  smtp_host          String?
  smtp_port          Int?
  smtp_username      String?
  user               User           @relation("UserEmailAccounts", fields: [user_id], references: [id], onDelete: Cascade)
  messages           EmailMessage[]
  sent_messages      EmailMessage[] @relation("SentFromAccount")

  @@unique([user_id, email])
  @@map("email_accounts")
}

model EmailMessage {
  id                   Int                      @id @default(autoincrement())
  account_id           Int
  thread_id            Int?
  message_id           String
  in_reply_to          String?
  references           Json?
  from_email           String
  from_name            String?
  to                   Json
  cc                   Json?
  bcc                  Json?
  subject              String
  body_text            String?
  body_html            String?
  snippet              String?
  folder               String                   @default("inbox")
  labels               Json?
  is_read              Boolean                  @default(false)
  is_starred           Boolean                  @default(false)
  is_draft             Boolean                  @default(false)
  has_attachments      Boolean                  @default(false)
  sent_at              DateTime?
  received_at          DateTime?
  person_id            Int?
  lead_id              Int?
  deal_id              Int?
  sent_from_crm        Boolean                  @default(false)
  sent_from_account_id Int?
  tracking_enabled     Boolean                  @default(false)
  provider_data        Json?
  created_at           DateTime                 @default(now())
  updated_at           DateTime                 @updatedAt
  scheduled_at         DateTime?
  attachments          EmailMessageAttachment[]
  account              EmailAccount             @relation(fields: [account_id], references: [id], onDelete: Cascade)
  deal                 Deal?                    @relation("EmailMessageDeal", fields: [deal_id], references: [id])
  lead                 Lead?                    @relation("EmailMessageLead", fields: [lead_id], references: [id])
  person               Person?                  @relation("EmailMessagePerson", fields: [person_id], references: [id])
  sent_from_account    EmailAccount?            @relation("SentFromAccount", fields: [sent_from_account_id], references: [id])
  thread               EmailThread?             @relation(fields: [thread_id], references: [id])
  tracking_events      EmailTracking[]

  @@unique([account_id, message_id])
  @@index([account_id, folder])
  @@index([thread_id])
  @@index([person_id])
  @@index([lead_id])
  @@index([deal_id])
  @@map("email_messages")
}

model EmailThread {
  id                 Int            @id @default(autoincrement())
  subject            String
  participant_emails Json
  last_message_at    DateTime
  message_count      Int            @default(0)
  created_at         DateTime       @default(now())
  updated_at         DateTime       @updatedAt
  messages           EmailMessage[]

  @@map("email_threads")
}

model EmailMessageAttachment {
  id            Int          @id @default(autoincrement())
  message_id    Int
  filename      String
  content_type  String
  size          Int
  storage_path  String?
  inline        Boolean      @default(false)
  content_id    String?
  attachment_id String?
  created_at    DateTime     @default(now())
  message       EmailMessage @relation(fields: [message_id], references: [id], onDelete: Cascade)

  @@map("email_message_attachments")
}

model EmailTracking {
  id         Int          @id @default(autoincrement())
  message_id Int
  event_type String
  ip_address String?
  user_agent String?
  link_url   String?
  country    String?
  city       String?
  tracked_at DateTime     @default(now())
  message    EmailMessage @relation(fields: [message_id], references: [id], onDelete: Cascade)

  @@index([message_id, event_type])
  @@map("email_tracking")
}

model EmailTemplate {
  id          Int      @id @default(autoincrement())
  user_id     Int
  name        String
  subject     String
  body        String
  description String?
  variables   Json?
  is_shared   Boolean  @default(false)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("email_templates")
}

model Activity {
  id              Int           @id @default(autoincrement())
  title           String
  description     String?
  type            String
  start_at        DateTime?
  end_at          DateTime?
  completed       Boolean       @default(false)
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  user_id         Int
  person_id       Int?
  lead_id         Int?
  deal_id         Int?
  organization_id Int?
  deal            Deal?         @relation(fields: [deal_id], references: [id])
  lead            Lead?         @relation(fields: [lead_id], references: [id])
  organization    Organization? @relation(fields: [organization_id], references: [id])
  person          Person?       @relation(fields: [person_id], references: [id])
  user            User          @relation(fields: [user_id], references: [id])

  @@map("activities")
}

model Task {
  id                  Int             @id @default(autoincrement())
  title               String
  description         String?
  task_type           String
  priority            String          @default("medium")
  status              String          @default("to_do")
  due_date            DateTime?
  due_time            String?
  estimated_duration  Int?
  actual_duration     Int?
  assigned_to_id      Int
  assigned_by_id      Int
  person_id           Int?
  organization_id     Int?
  lead_id             Int?
  deal_id             Int?
  is_recurring        Boolean         @default(false)
  recurrence_pattern  String?
  recurrence_end_date DateTime?
  parent_task_id      Int?
  tags                Json?
  attachments         Json?
  checklist           Json?
  created_at          DateTime        @default(now())
  updated_at          DateTime        @updatedAt
  completed_at        DateTime?
  assigned_by_role    String
  assigned_to_role    String
  progress            Int             @default(0)
  calendar_events     CalendarEvent[]
  notifications       Notification[]
  comments            TaskComment[]
  time_logs           TaskTimeLog[]
  assigned_by         User            @relation("TasksAssignedBy", fields: [assigned_by_id], references: [id])
  assigned_to         User            @relation("TasksAssignedTo", fields: [assigned_to_id], references: [id])
  deal                Deal?           @relation(fields: [deal_id], references: [id])
  lead                Lead?           @relation(fields: [lead_id], references: [id])
  organization        Organization?   @relation(fields: [organization_id], references: [id])
  parent_task         Task?           @relation("RecurringTasks", fields: [parent_task_id], references: [id])
  child_tasks         Task[]          @relation("RecurringTasks")
  person              Person?         @relation(fields: [person_id], references: [id])

  @@map("tasks")
}

model TaskComment {
  id         Int      @id @default(autoincrement())
  task_id    Int
  user_id    Int
  comment    String
  created_at DateTime @default(now())
  task       Task     @relation(fields: [task_id], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [user_id], references: [id])

  @@map("task_comments")
}

model TaskTimeLog {
  id        Int      @id @default(autoincrement())
  task_id   Int
  user_id   Int
  duration  Int
  note      String?
  logged_at DateTime @default(now())
  task      Task     @relation(fields: [task_id], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [user_id], references: [id])

  @@map("task_time_logs")
}

model CalendarEvent {
  id                 Int           @id @default(autoincrement())
  title              String
  description        String?
  event_type         String
  start_date         DateTime
  end_date           DateTime
  all_day            Boolean       @default(false)
  location           String?
  user_id            Int
  task_id            Int?
  person_id          Int?
  organization_id    Int?
  lead_id            Int?
  deal_id            Int?
  is_recurring       Boolean       @default(false)
  recurrence_pattern String?
  created_at         DateTime      @default(now())
  updated_at         DateTime      @updatedAt
  deal               Deal?         @relation(fields: [deal_id], references: [id])
  lead               Lead?         @relation(fields: [lead_id], references: [id])
  organization       Organization? @relation(fields: [organization_id], references: [id])
  person             Person?       @relation(fields: [person_id], references: [id])
  task               Task?         @relation(fields: [task_id], references: [id])
  user               User          @relation(fields: [user_id], references: [id])

  @@map("calendar_events")
}

model LeadSource {
  id         Int      @id @default(autoincrement())
  name       String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  leads      Lead[]

  @@map("lead_sources")
}

model LeadType {
  id         Int      @id @default(autoincrement())
  name       String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  leads      Lead[]

  @@map("lead_types")
}

model VoipProvider {
  id             Int         @id @default(autoincrement())
  name           String
  provider_type  String
  account_sid    String?
  auth_token     String?
  api_key_sid    String?
  api_key_secret String?
  twiml_app_sid  String?
  api_key        String?
  connection_id  String?
  webhook_secret String?
  sip_server     String?
  sip_port       Int?
  sip_username   String?
  sip_password   String?
  transport      String?
  from_number    String
  active         Boolean     @default(true)
  created_at     DateTime    @default(now())
  updated_at     DateTime    @updatedAt
  trunks         VoipTrunk[]

  @@map("voip_providers")
}

model VoipTrunk {
  id                    Int            @id @default(autoincrement())
  name                  String
  provider_id           Int
  sip_domain            String
  sip_port              Int            @default(5060)
  transport_protocol    String         @default("UDP")
  auth_method           String         @default("username")
  sip_username          String?
  sip_password          String?
  registration_required Boolean        @default(false)
  options_context       String?
  active                Boolean        @default(true)
  created_at            DateTime       @default(now())
  updated_at            DateTime       @updatedAt
  inbound_routes        InboundRoute[]
  provider              VoipProvider   @relation(fields: [provider_id], references: [id], onDelete: Cascade)

  @@map("voip_trunks")
}

model InboundRoute {
  id               Int       @id @default(autoincrement())
  name             String
  did_pattern      String
  destination_type String
  destination_id   String
  trunk_id         Int
  priority         Int       @default(1)
  active           Boolean   @default(true)
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt
  trunk            VoipTrunk @relation(fields: [trunk_id], references: [id], onDelete: Cascade)

  @@map("inbound_routes")
}

model CallRecording {
  id            Int      @id @default(autoincrement())
  recording_sid String   @unique
  from_number   String
  to_number     String
  direction     String
  user_id       Int?
  duration      Int
  recording_url String?
  status        String   @default("completed")
  created_at    DateTime @default(now())
  user          User?    @relation(fields: [user_id], references: [id])

  @@map("call_recordings")
}

model Notification {
  id         Int      @id @default(autoincrement())
  user_id    Int
  task_id    Int?
  lead_id    Int?
  message    String
  is_read    Boolean  @default(false)
  created_at DateTime @default(now())
  task       Task?    @relation(fields: [task_id], references: [id])
  lead       Lead?    @relation(fields: [lead_id], references: [id])
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("notifications")
}
