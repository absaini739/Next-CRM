generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User & Auth
model User {
  id              Int       @id @default(autoincrement())
  name            String
  email           String    @unique
  password        String?
  status          Boolean   @default(false)
  role_id         Int
  remember_token  String?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  role            Role      @relation(fields: [role_id], references: [id])
  persons         Person[]
  organizations   Organization[]
  leads           Lead[]
  deals           Deal[]
  quotes          Quote[]
  activities      Activity[]
  emails          Email[]

  @@map("users")
}

model Role {
  id              Int       @id @default(autoincrement())
  name            String
  description     String?
  permission_type String
  permissions     Json?     // Stores array of permission strings/objects
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  users           User[]

  @@map("roles")
}

model Group {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("groups")
}

// Contacts
model Person {
  id              Int       @id @default(autoincrement())
  name            String
  emails          Json      // Stores array of {value, label}
  contact_numbers Json?     // Stores array of {value, label}
  organization_id Int?
  user_id         Int?      // Owner
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  organization    Organization? @relation(fields: [organization_id], references: [id])
  user            User?         @relation(fields: [user_id], references: [id])
  leads           Lead[]
  deals           Deal[]
  quotes          Quote[]
  activities      Activity[]
  sentEmails      Email[]

  @@map("persons")
}

model Organization {
  id          Int       @id @default(autoincrement())
  name        String
  address     Json?     // Stores array of addresses
  user_id     Int?
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  user        User?     @relation(fields: [user_id], references: [id])
  persons     Person[]
  // leads       Lead[] -- Implicit or missing keys

  @@map("organizations")
}

// Settings / Lookups for Leads
model LeadSource {
  id    Int    @id @default(autoincrement())
  name  String
  leads Lead[]
  deals Deal[]

  @@map("lead_sources")
}

model LeadType {
  id    Int    @id @default(autoincrement())
  name  String
  leads Lead[]
  deals Deal[]

  @@map("lead_types")
}

model LeadPipeline {
  id          Int                 @id @default(autoincrement())
  name        String
  stages      LeadPipelineStage[]
  leads       Lead[]
  deals       Deal[]
  rotten_days Int?                @default(0)
  is_default  Boolean             @default(false)
  created_at  DateTime            @default(now())
  updated_at  DateTime            @updatedAt

  @@map("lead_pipelines")
}

model LeadPipelineStage {
  id               Int          @id @default(autoincrement())
  name             String
  code             String?
  probability      Int?         @default(0)
  sort_order       Int?         @default(0)
  lead_pipeline_id Int
  pipeline         LeadPipeline @relation(fields: [lead_pipeline_id], references: [id])
  // leads            Lead[] -- Field mismatch
  deals            Deal[]

  @@map("lead_pipeline_stages")
}

model LeadStage {
  id    Int    @id @default(autoincrement())
  name  String
  leads Lead[]

  @@map("lead_stages")
}

// Leads
model Lead {
  id              Int       @id @default(autoincrement())
  title           String
  description     String?
  lead_value      Decimal?  @db.Decimal(12, 4)
  status          Int?      // 1: Won, 0: Lost? Need to verify semantics
  lost_reason     String?
  closed_at       DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  user_id                 Int
  person_id               Int
  lead_source_id          Int
  lead_type_id            Int
  lead_pipeline_id        Int?
  lead_stage_id           Int? // Referring to generic stage or pipeline stage? Migration has lead_stage_id AND pipeline_stage keys in history. 
                                 // "2021_04_22_164215_create_leads_table.php" shows `lead_stage_id` and `lead_pipeline_id`.
                                 // Later migrations might have adjusted. Sticking to initial 2021 schema + 2024 updates.

  user                    User                @relation(fields: [user_id], references: [id])
  person                  Person              @relation(fields: [person_id], references: [id])
  source                  LeadSource          @relation(fields: [lead_source_id], references: [id])
  type                    LeadType            @relation(fields: [lead_type_id], references: [id])
  pipeline                LeadPipeline?       @relation(fields: [lead_pipeline_id], references: [id])
  stage                   LeadStage?          @relation(fields: [lead_stage_id], references: [id])

  // Relations
  deals Deal[]
  // quotes Quote[] -- Link table needed, skipping for now
  activities Activity[]
  emails     Email[]
  
  @@map("leads")
}

// Deals
model Deal {
  id                  Int       @id @default(autoincrement())
  title               String
  description         String?
  deal_value          Decimal   @default(0) @db.Decimal(12, 4)
  status              String    @default("open") // 'open', 'won', 'lost'
  lost_reason         String?
  expected_close_date DateTime? @db.Date
  closed_at           DateTime?
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  user_id                 Int?
  person_id               Int?
  lead_id                 Int?
  lead_source_id          Int?
  lead_type_id            Int?
  lead_pipeline_id        Int?
  lead_pipeline_stage_id  Int?

  user      User?              @relation(fields: [user_id], references: [id])
  person    Person?            @relation(fields: [person_id], references: [id])
  lead      Lead?              @relation(fields: [lead_id], references: [id])
  source    LeadSource?        @relation(fields: [lead_source_id], references: [id])
  type      LeadType?          @relation(fields: [lead_type_id], references: [id])
  pipeline  LeadPipeline?      @relation(fields: [lead_pipeline_id], references: [id])
  stage     LeadPipelineStage? @relation(fields: [lead_pipeline_stage_id], references: [id])
  
  activities Activity[]
  emails     Email[]

  @@map("deals")
}

// Products
model Product {
  id          Int      @id @default(autoincrement())
  sku         String   @unique
  name        String?
  description String?
  quantity    Int      @default(0)
  price       Decimal? @db.Decimal(12, 4)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  quoteItems  QuoteItem[]

  @@map("products")
}

// Quotes
model Quote {
  id                Int       @id @default(autoincrement())
  subject           String
  description       String?
  billing_address   Json?
  shipping_address  Json?
  discount_percent  Decimal?  @default(0) @db.Decimal(12, 4)
  discount_amount   Decimal?  @default(0) @db.Decimal(12, 4)
  tax_amount        Decimal?  @default(0) @db.Decimal(12, 4)
  adjustment_amount Decimal?  @default(0) @db.Decimal(12, 4)
  sub_total         Decimal?  @default(0) @db.Decimal(12, 4)
  grand_total       Decimal?  @default(0) @db.Decimal(12, 4)
  expired_at        DateTime?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  person_id         Int
  user_id           Int

  person            Person    @relation(fields: [person_id], references: [id])
  user              User      @relation(fields: [user_id], references: [id])
  items             QuoteItem[]

  @@map("quotes")
}

model QuoteItem {
  id              Int      @id @default(autoincrement())
  sku             String?
  name            String?
  quantity        Int?     @default(0)
  price           Decimal  @default(0) @db.Decimal(12, 4)
  coupon_code     String?
  discount_percent Decimal? @default(0) @db.Decimal(12, 4)
  discount_amount  Decimal? @default(0) @db.Decimal(12, 4)
  tax_percent     Decimal? @default(0) @db.Decimal(12, 4)
  tax_amount      Decimal? @default(0) @db.Decimal(12, 4)
  total           Decimal  @default(0) @db.Decimal(12, 4)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  product_id      Int
  quote_id        Int

  product         Product  @relation(fields: [product_id], references: [id])
  quote           Quote    @relation(fields: [quote_id], references: [id])

  @@map("quote_items")
}

// Emails
model Email {
  id              Int       @id @default(autoincrement())
  from            String
  to              Json      // Array of email addresses
  cc              Json?     // Array of email addresses
  bcc             Json?     // Array of email addresses
  subject         String
  body            String    @db.Text
  folder          String    @default("inbox") // inbox, draft, outbox, sent, archive, trash
  is_read         Boolean   @default(false)
  is_starred      Boolean   @default(false)
  has_attachments Boolean   @default(false)
  sent_at         DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  user_id         Int
  person_id       Int?
  lead_id         Int?
  deal_id         Int?
  
  user            User      @relation(fields: [user_id], references: [id])
  person          Person?   @relation(fields: [person_id], references: [id])
  lead            Lead?     @relation(fields: [lead_id], references: [id])
  deal            Deal?     @relation(fields: [deal_id], references: [id])
  attachments     EmailAttachment[]
  
  @@map("emails")
}

model EmailAttachment {
  id         Int      @id @default(autoincrement())
  filename   String
  filepath   String
  filesize   Int
  mimetype   String
  email_id   Int
  created_at DateTime @default(now())
  
  email      Email    @relation(fields: [email_id], references: [id], onDelete: Cascade)
  
  @@map("email_attachments")
}

// Activities
model Activity {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  type        String   // 'call', 'meeting', 'task', 'note', 'email'
  start_at    DateTime?
  end_at      DateTime?
  completed   Boolean  @default(false)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  user_id     Int
  person_id   Int?
  lead_id     Int?
  deal_id     Int?

  user        User     @relation(fields: [user_id], references: [id])
  person      Person?  @relation(fields: [person_id], references: [id])
  lead        Lead?    @relation(fields: [lead_id], references: [id])
  deal        Deal?    @relation(fields: [deal_id], references: [id])

  @@map("activities")
}
